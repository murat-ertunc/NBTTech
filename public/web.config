<?xml version="1.0" encoding="UTF-8"?>
<!--
=============================================================================
PUBLIC web.config - Front Controller (IIS 10)
=============================================================================
Pretty URL'ler için tüm istekleri index.php'ye yönlendirir
Static dosyalar (assets, images) doğrudan sunulur
=============================================================================
-->
<configuration>
    <system.webServer>

        <!-- Dizin listelemeyi kapat -->
        <directoryBrowse enabled="false" />

        <!-- Varsayılan belge -->
        <defaultDocument>
            <files>
                <clear />
                <add value="index.php" />
            </files>
        </defaultDocument>

        <rewrite>
            <rules>

                <!--
                =============================================================
                INTERNAL FILES: __internal__/*.php doğrudan çalıştır
                Migration ve admin scriptleri için (Basic Auth korumalı)
                =============================================================
                -->
                <rule name="Internal PHP Scripts" stopProcessing="true">
                    <match url="^__internal__/(.*)\.php$" />
                    <conditions>
                        <add input="{REQUEST_FILENAME}" matchType="IsFile" />
                    </conditions>
                    <action type="None" />
                </rule>

                <!--
                =============================================================
                STATIC FILES: Fiziksel dosya varsa doğrudan sun
                assets/, images/, *.css, *.js, *.txt, *.ico vb.
                =============================================================
                -->
                <rule name="Static Files" stopProcessing="true">
                    <match url="^(.*)$" />
                    <conditions logicalGrouping="MatchAll">
                        <add input="{REQUEST_FILENAME}" matchType="IsFile" />
                        <!-- PHP dosyaları hariç - onlar front controller'a gider -->
                        <add input="{REQUEST_URI}" pattern="\.php$" negate="true" />
                    </conditions>
                    <action type="None" />
                </rule>

                <!--
                =============================================================
                DIRECTORY PASSTHROUGH: Fiziksel dizin varsa (index file ile)
                =============================================================
                -->
                <rule name="Directory Passthrough" stopProcessing="true">
                    <match url="^(.*)$" />
                    <conditions logicalGrouping="MatchAll">
                        <add input="{REQUEST_FILENAME}" matchType="IsDirectory" />
                    </conditions>
                    <action type="None" />
                </rule>

                <!--
                =============================================================
                ROOT PHP FILES: login.php, 404.php vb. doğrudan çalıştır
                =============================================================
                -->
                <rule name="Root PHP Files" stopProcessing="true">
                    <match url="^([a-zA-Z0-9_-]+)\.php$" />
                    <conditions>
                        <add input="{REQUEST_FILENAME}" matchType="IsFile" />
                    </conditions>
                    <action type="None" />
                </rule>

                <!--
                =============================================================
                FRONT CONTROLLER: Diğer tüm istekler → index.php
                Pretty URL'ler buradan çözülür: /logs, /customer/123 vb.
                =============================================================
                -->
                <rule name="Front Controller" stopProcessing="true">
                    <match url="^(.*)$" />
                    <conditions logicalGrouping="MatchAll">
                        <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
                        <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
                    </conditions>
                    <action type="Rewrite" url="index.php" appendQueryString="true" />
                </rule>

            </rules>
        </rewrite>

    </system.webServer>
</configuration>
