# =============================================================================
# ROOT .htaccess - Güvenlik ve Public Proxy
# =============================================================================
# Document root = repo kökü olan hostingler için
# Tüm istekler /public altına yönlendirilir
# =============================================================================

# Dizin listesini ve MultiViews'u kapat
Options -Indexes -MultiViews

<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /

    # =========================================================================
    # DEBUG/TEST: .htaccess'in çalıştığını doğrulamak için
    # GET /__htaccess_test → 403 Forbidden dönmeli
    # =========================================================================
    RewriteRule ^__htaccess_test$ - [F,L]

    # =========================================================================
    # GÜVENLİK: Hassas dizin ve dosyalara erişimi engelle
    # =========================================================================
    RewriteRule ^(src|bootstrap|tests|config|database|storage|sql|routes)(/|$) - [F,L]
    RewriteRule ^\.env - [F,L]
    RewriteRule ^\.git - [F,L]
    RewriteRule ^(Dockerfile|docker-compose\.yml|composer\.(json|lock))$ - [F,L]

    # =========================================================================
    # ROOT DOSYALARI: index.php, login.php vb root'ta varsa sun
    # =========================================================================
    RewriteCond %{REQUEST_FILENAME} -f
    RewriteRule ^[^/]+\.(php|html|txt|ico)$ - [L]

    # =========================================================================
    # PUBLIC PROXY: Tüm istekleri /public altına yönlendir
    # Zaten public/ ile başlıyorsa veya root'ta gerçek dosya varsa atla
    # =========================================================================
    
    # public/ ile başlayan istekleri olduğu gibi bırak
    RewriteRule ^public(/.*)?$ - [L]

    # Diğer tüm istekleri public/ altına internal rewrite yap
    RewriteRule ^(.*)$ public/$1 [L]
</IfModule>

# =========================================================================
# GÜVENLİK: Gizli ve hassas dosyalar
# =========================================================================
<FilesMatch "^\.">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order deny,allow
        Deny from all
    </IfModule>
</FilesMatch>

<FilesMatch "\.(sql|log|bak|config|ini|sh)$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order deny,allow
        Deny from all
    </IfModule>
</FilesMatch>
