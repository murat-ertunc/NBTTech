# =============================================================================
# ROOT .htaccess - Güvenlik ve Routing
# =============================================================================
# Plan B kullanımı için: Hosting document root = repo kökü
# Plan A için bu dosya gereksizdir (document root = /public)
# =============================================================================

# Dizin listesini devre dışı bırak + MultiViews kapat (path çakışması önlenir)
Options -Indexes -MultiViews

<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /

    # =========================================================================
    # DEBUG/TEST: .htaccess'in çalıştığını doğrulamak için
    # GET /__htaccess_test → 403 Forbidden dönmeli
    # Test sonrası bu satırı silebilirsiniz
    # =========================================================================
    RewriteRule ^__htaccess_test$ - [F,L]

    # =========================================================================
    # GÜVENLİK: Hassas dizin ve dosyalara erişimi engelle
    # =========================================================================
    RewriteRule ^(src|bootstrap|tests|config|database|storage|sql|routes)(/|$) - [F,L]
    RewriteRule ^\.env - [F,L]
    RewriteRule ^\.git - [F,L]
    RewriteRule ^(Dockerfile|docker-compose\.yml|composer\.(json|lock))$ - [F,L]

    # =========================================================================
    # STATICS: /pages/* ve /assets/* → /public altına yönlendir
    # [PT] = PassThrough - Apache'nin dosyayı bulup çalıştırmasını sağlar
    # Loop önleme: Zaten public/ ile başlıyorsa atlat
    # =========================================================================
    RewriteCond %{REQUEST_URI} !^/public/
    RewriteRule ^pages/(.*)$ /public/pages/$1 [PT,L]

    RewriteCond %{REQUEST_URI} !^/public/
    RewriteRule ^assets/(.*)$ /public/assets/$1 [PT,L]

    # =========================================================================
    # PUBLIC ALT DİZİNLERİNE DOĞRUDAN ERİŞİM (isteğe bağlı güvenlik)
    # /public/pages/... şeklinde gelen istekleri de kabul et
    # =========================================================================
    RewriteCond %{REQUEST_FILENAME} -f
    RewriteRule ^public/(pages|assets)/(.*)$ - [L]

    # =========================================================================
    # FALLBACK: Diğer tüm istekler → /index.php (front controller)
    # =========================================================================
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.*)$ index.php [QSA,L]
</IfModule>

# =========================================================================
# EKSTRA GÜVENLİK
# =========================================================================

# .env, .htaccess, .git dosyalarına erişimi engelle
<FilesMatch "^\.">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order deny,allow
        Deny from all
    </IfModule>
</FilesMatch>

# Hassas dosya uzantılarını engelle
<FilesMatch "\.(sql|log|bak|config|ini|sh)$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order deny,allow
        Deny from all
    </IfModule>
</FilesMatch>
