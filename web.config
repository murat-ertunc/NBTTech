<?xml version="1.0" encoding="UTF-8"?>
<!--
=============================================================================
ROOT web.config - Güvenlik ve Public Proxy (IIS 10)
=============================================================================
Document root = repo kökü olan hostingler için
URL Rewrite modülü gerektirir: https://www.iis.net/downloads/microsoft/url-rewrite
=============================================================================
-->
<configuration>
    <system.webServer>

        <!-- Dizin listelemeyi kapat -->
        <directoryBrowse enabled="false" />

        <!-- Varsayılan belge -->
        <defaultDocument>
            <files>
                <clear />
                <add value="index.php" />
                <add value="index.html" />
            </files>
        </defaultDocument>

        <!-- Hata sayfaları -->
        <httpErrors errorMode="Custom" existingResponse="Replace">
            <remove statusCode="404" />
            <error statusCode="404" path="/public/404.php" responseMode="ExecuteURL" />
        </httpErrors>

        <!-- Güvenlik: Hassas dosya uzantılarına erişimi engelle -->
        <security>
            <requestFiltering>
                <fileExtensions>
                    <add fileExtension=".env" allowed="false" />
                    <add fileExtension=".sql" allowed="false" />
                    <add fileExtension=".log" allowed="false" />
                    <add fileExtension=".bak" allowed="false" />
                    <add fileExtension=".sh" allowed="false" />
                    <add fileExtension=".ini" allowed="false" />
                    <add fileExtension=".yml" allowed="false" />
                    <add fileExtension=".yaml" allowed="false" />
                    <add fileExtension=".lock" allowed="false" />
                </fileExtensions>
                <hiddenSegments>
                    <add segment=".git" />
                    <add segment=".env" />
                    <add segment="node_modules" />
                </hiddenSegments>
            </requestFiltering>
        </security>

        <rewrite>
            <rules>

                <!--
                =============================================================
                GÜVENLİK: Hassas dizinlere erişimi 403 ile engelle
                src, bootstrap, tests, config, database, storage, sql, routes
                =============================================================
                -->
                <rule name="Block Sensitive Directories" stopProcessing="true">
                    <match url="^(src|bootstrap|tests|config|database|storage|sql|routes)(/.*)?$" ignoreCase="true" />
                    <action type="CustomResponse" statusCode="403" statusReason="Forbidden" statusDescription="Access Denied" />
                </rule>

                <!--
                =============================================================
                GÜVENLİK: Gizli dosyalara erişimi engelle
                .env, .git, Dockerfile, composer.json vb.
                =============================================================
                -->
                <rule name="Block Hidden Files" stopProcessing="true">
                    <match url="^\." />
                    <action type="CustomResponse" statusCode="403" statusReason="Forbidden" statusDescription="Access Denied" />
                </rule>

                <rule name="Block Dockerfile" stopProcessing="true">
                    <match url="^(Dockerfile|docker-compose\.yml|composer\.(json|lock))$" ignoreCase="true" />
                    <action type="CustomResponse" statusCode="403" statusReason="Forbidden" statusDescription="Access Denied" />
                </rule>

                <!--
                =============================================================
                PUBLIC PASS-THROUGH: /public/ ile başlayan istekler olduğu gibi
                =============================================================
                -->
                <rule name="Public Passthrough" stopProcessing="true">
                    <match url="^public(/.*)?$" />
                    <conditions>
                        <add input="{REQUEST_FILENAME}" matchType="IsFile" />
                    </conditions>
                    <action type="None" />
                </rule>

                <rule name="Public Directory Passthrough" stopProcessing="true">
                    <match url="^public(/.*)?$" />
                    <conditions>
                        <add input="{REQUEST_FILENAME}" matchType="IsDirectory" />
                    </conditions>
                    <action type="None" />
                </rule>

                <!--
                =============================================================
                ROOT STATIC FILES: Root'ta fiziksel dosya varsa sun
                =============================================================
                -->
                <rule name="Root Static Files" stopProcessing="true">
                    <match url="^[^/]+\.(php|html|txt|ico|xml|json)$" />
                    <conditions>
                        <add input="{REQUEST_FILENAME}" matchType="IsFile" />
                    </conditions>
                    <action type="None" />
                </rule>

                <!--
                =============================================================
                PUBLIC PROXY: Diğer tüm istekleri /public/ altına yönlendir
                =============================================================
                -->
                <rule name="Public Proxy" stopProcessing="true">
                    <match url="^(.*)$" />
                    <conditions>
                        <!-- public/ ile başlamayanları yönlendir -->
                        <add input="{REQUEST_URI}" pattern="^/public(/.*)?$" negate="true" />
                    </conditions>
                    <action type="Rewrite" url="public/{R:1}" />
                </rule>

            </rules>
        </rewrite>

        <!-- PHP handler ayarları (IIS PHP Manager kullanılıyorsa otomatik) -->
        <handlers>
            <!-- PHP handler buraya IIS tarafından eklenir -->
        </handlers>

    </system.webServer>
</configuration>
